# Guide Maintenance Personnel - Serveur MCP EBP

## üìç Emplacements des Logs

### Logs Principaux du Serveur MCP

#### 1. Logs d'Application (si configur√©s)
```powershell
# Emplacement principal
C:\Services\EBP-MCP-Server\logs\

# Types de fichiers :
# - app.log : Logs g√©n√©raux d'application
# - error.log : Erreurs uniquement
# - access.log : Requ√™tes utilisateur
# - sql.log : Requ√™tes SQL ex√©cut√©es (si debug activ√©)
```

#### 2. Logs Console (si pas de service Windows)
```powershell
# Lancer avec redirection des logs
cd C:\Services\EBP-MCP-Server
node dist/index.js > logs\console.log 2>&1
```

#### 3. Logs Service Windows
```powershell
# Logs du service Windows (si install√© avec NSSM)
Get-EventLog -LogName Application -Source "EBP-MCP-Server" -Newest 50

# Ou dans l'Event Viewer Windows :
eventvwr.msc
# ‚Üí Applications and Services Logs ‚Üí EBP-MCP-Server
```

#### 4. Logs Claude Desktop
```powershell
# Logs Claude Desktop (pour debug connexion MCP)
%APPDATA%\Claude\logs\

# Ou g√©n√©ralement :
C:\Users\[USERNAME]\AppData\Roaming\Claude\logs\
```

#### 5. Logs SQL Server (pour requ√™tes lentes)
```sql
-- Sur le serveur SQL
SELECT TOP 100
    qs.execution_count,
    qs.total_elapsed_time / 1000000 as total_seconds,
    qs.total_elapsed_time / qs.execution_count / 1000000.0 as avg_seconds,
    SUBSTRING(qt.text, (qs.statement_start_offset/2)+1,
        ((CASE qs.statement_end_offset
            WHEN -1 THEN DATALENGTH(qt.text)
            ELSE qs.statement_end_offset
        END - qs.statement_start_offset)/2) + 1) as query_text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt
WHERE qt.text LIKE '%SaleDocument%'
ORDER BY qs.total_elapsed_time DESC;
```

---

## üîß Routine de Maintenance

### QUOTIDIEN (5 minutes)

#### Matin - V√©rification Sant√©
```powershell
# Script de v√©rification quotidienne
function Check-Daily {
    Write-Host "=== CHECK QUOTIDIEN ===" -ForegroundColor Cyan
    
    # 1. V√©rifier le service
    $service = Get-Service "EBP-MCP-Server" -ErrorAction SilentlyContinue
    if ($service) {
        Write-Host "Service Status: $($service.Status)" -ForegroundColor $(if($service.Status -eq "Running"){"Green"}else{"Red"})
    } else {
        Write-Host "Mode Console (pas de service)" -ForegroundColor Yellow
    }
    
    # 2. V√©rifier l'espace disque
    $disk = Get-PSDrive C
    $freeGB = [math]::Round($disk.Free / 1GB, 2)
    Write-Host "Espace disque libre: $freeGB GB" -ForegroundColor $(if($freeGB -gt 10){"Green"}else{"Red"})
    
    # 3. V√©rifier la taille des logs
    $logPath = "C:\Services\EBP-MCP-Server\logs"
    if (Test-Path $logPath) {
        $logSize = (Get-ChildItem $logPath -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "Taille totale logs: $([math]::Round($logSize, 2)) MB" -ForegroundColor $(if($logSize -lt 100){"Green"}else{"Yellow"})
    }
    
    # 4. V√©rifier les erreurs r√©centes
    $errorLog = "$logPath\error.log"
    if (Test-Path $errorLog) {
        $recentErrors = Get-Content $errorLog -Tail 10 | Where-Object {$_ -match "ERROR"}
        if ($recentErrors) {
            Write-Host "‚ö†Ô∏è Erreurs r√©centes d√©tect√©es!" -ForegroundColor Red
            $recentErrors | Select-Object -First 3
        } else {
            Write-Host "‚úÖ Pas d'erreurs r√©centes" -ForegroundColor Green
        }
    }
    
    # 5. Test rapide de connexion SQL
    try {
        $conn = New-Object System.Data.SqlClient.SqlConnection
        $conn.ConnectionString = "Server=SRVDEV2025\EBP;Database=BIJOU_X3;Integrated Security=true;TrustServerCertificate=true"
        $conn.Open()
        $conn.Close()
        Write-Host "‚úÖ Connexion SQL OK" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Erreur connexion SQL!" -ForegroundColor Red
    }
}

# Ex√©cuter
Check-Daily
```

### HEBDOMADAIRE (15 minutes)

#### Lundi Matin - Maintenance Pr√©ventive
```powershell
function Maintenance-Weekly {
    Write-Host "=== MAINTENANCE HEBDOMADAIRE ===" -ForegroundColor Cyan
    
    # 1. Rotation des logs (garder 30 jours)
    $logPath = "C:\Services\EBP-MCP-Server\logs"
    $oldDate = (Get-Date).AddDays(-30)
    
    Get-ChildItem "$logPath\*.log" | Where-Object {$_.LastWriteTime -lt $oldDate} | ForEach-Object {
        Write-Host "Archivage: $($_.Name)"
        Move-Item $_.FullName "$logPath\archive\$($_.Name).old" -Force
    }
    
    # 2. Nettoyage des logs Claude Desktop
    $claudeLogs = "$env:APPDATA\Claude\logs"
    if (Test-Path $claudeLogs) {
        Get-ChildItem $claudeLogs -Filter "*.log" | 
            Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-7)} | 
            Remove-Item -Force
        Write-Host "‚úÖ Logs Claude nettoy√©s"
    }
    
    # 3. Analyse performance
    $perfLog = @"
    Date: $(Get-Date)
    CPU Moyen: $((Get-Counter "\Process(node*)\% Processor Time").CounterSamples.CookedValue)%
    RAM Utilis√©e: $([math]::Round((Get-Process node -ErrorAction SilentlyContinue).WorkingSet64 / 1MB, 2)) MB
"@
    $perfLog | Out-File "$logPath\performance_weekly.log" -Append
    
    # 4. Backup configuration
    $backupPath = "C:\Services\EBP-MCP-Server\backups\$(Get-Date -Format 'yyyy-MM-dd')"
    New-Item -ItemType Directory -Path $backupPath -Force | Out-Null
    
    Copy-Item "C:\Services\EBP-MCP-Server\.env" "$backupPath\.env.backup"
    Copy-Item "$env:APPDATA\Claude\claude_desktop_config.json" "$backupPath\claude_config.backup"
    Write-Host "‚úÖ Backup configuration effectu√© dans $backupPath"
    
    # 5. Red√©marrage pr√©ventif du service
    $response = Read-Host "Red√©marrer le service maintenant ? (O/N)"
    if ($response -eq 'O') {
        Restart-Service "EBP-MCP-Server"
        Write-Host "‚úÖ Service red√©marr√©"
    }
}

# Ex√©cuter
Maintenance-Weekly
```

### MENSUEL (30 minutes)

#### Premier Lundi du Mois
```powershell
function Maintenance-Monthly {
    Write-Host "=== MAINTENANCE MENSUELLE ===" -ForegroundColor Cyan
    
    # 1. Mise √† jour des d√©pendances
    Write-Host "V√©rification des mises √† jour npm..."
    cd C:\Services\EBP-MCP-Server
    npm outdated
    
    $update = Read-Host "Mettre √† jour les d√©pendances ? (O/N)"
    if ($update -eq 'O') {
        npm update
        npm audit fix
        npm run build
        Write-Host "‚úÖ D√©pendances mises √† jour"
    }
    
    # 2. Analyse des requ√™tes SQL lentes
    Write-Host "`nAnalyse des requ√™tes lentes..."
    # Cr√©er rapport des requ√™tes > 5 secondes
    
    # 3. Rapport d'utilisation
    $startDate = (Get-Date).AddMonths(-1)
    $report = @"
    
    === RAPPORT MENSUEL ===
    P√©riode: $($startDate.ToString('yyyy-MM')) 
    
    Statistiques:
    - Nombre total de requ√™tes: $(Get-Content "$logPath\access.log" | Measure-Object -Line).Lines
    - Erreurs totales: $(Get-Content "$logPath\error.log" | Select-String "ERROR" | Measure-Object -Line).Lines
    - Taille totale logs: $([math]::Round((Get-ChildItem $logPath -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)) MB
    
    Top 5 requ√™tes les plus fr√©quentes:
    $(Get-Content "$logPath\access.log" | Group-Object | Sort-Object Count -Descending | Select-Object -First 5 | Format-Table -AutoSize | Out-String)
"@
    
    $report | Out-File "C:\Services\EBP-MCP-Server\reports\monthly_$(Get-Date -Format 'yyyy-MM').txt"
    Write-Host $report
    
    # 4. Test complet
    Write-Host "`nTest complet du syst√®me..."
    node C:\Services\EBP-MCP-Server\dist\test-connection.js
    
    # 5. V√©rification de s√©curit√©
    Write-Host "`nV√©rification s√©curit√©..."
    # V√©rifier que .env n'est pas dans git
    cd C:\Services\EBP-MCP-Server
    git status --ignored | Select-String ".env"
    
    Write-Host "‚úÖ Maintenance mensuelle termin√©e"
}

# Ex√©cuter
Maintenance-Monthly
```

---

## üö® R√©solution de Probl√®mes

### Probl√®me : Service ne d√©marre pas

```powershell
# 1. V√©rifier les logs Windows
Get-EventLog -LogName Application -Source "EBP-MCP-Server" -Newest 20

# 2. Tester en mode console pour voir l'erreur
cd C:\Services\EBP-MCP-Server
node dist/index.js

# 3. V√©rifier le fichier .env
Get-Content .env

# 4. Recr√©er le service si n√©cessaire
.\nssm.exe remove "EBP-MCP-Server" confirm
.\nssm.exe install "EBP-MCP-Server" "C:\Program Files\nodejs\node.exe"
```

### Probl√®me : Erreurs SQL fr√©quentes

```powershell
# 1. Identifier les requ√™tes probl√©matiques
Get-Content C:\Services\EBP-MCP-Server\logs\sql.log | Select-String "error" -Context 2,2

# 2. Tester la connexion manuellement
$conn = New-Object System.Data.SqlClient.SqlConnection
$conn.ConnectionString = "Server=SRVDEV2025\EBP;Database=BIJOU_X3;Integrated Security=true"
try {
    $conn.Open()
    Write-Host "Connexion OK"
    $conn.Close()
} catch {
    Write-Host "Erreur: $_"
}

# 3. V√©rifier les permissions SQL
sqlcmd -S SRVDEV2025\EBP -d BIJOU_X3 -Q "SELECT * FROM fn_my_permissions(NULL, 'DATABASE')"
```

### Probl√®me : Claude Desktop ne r√©pond pas

```powershell
# 1. V√©rifier la config
Get-Content "$env:APPDATA\Claude\claude_desktop_config.json" | ConvertFrom-Json | Format-List

# 2. V√©rifier que le serveur MCP tourne
Get-Process | Where-Object {$_.Name -like "*node*"}

# 3. Relancer Claude Desktop
Stop-Process -Name "Claude*" -Force
Start-Process "claude.exe"  # Ou via le raccourci

# 4. V√©rifier les logs Claude
Get-Content "$env:APPDATA\Claude\logs\main.log" -Tail 50
```

### Probl√®me : Performance d√©grad√©e

```powershell
# 1. Analyser l'utilisation CPU/RAM
Get-Process node | Select-Object CPU, WorkingSet64, 
    @{n='RAM(MB)';e={$_.WorkingSet64/1MB}},
    @{n='CPU(%)';e={$_.CPU}}

# 2. Identifier les requ√™tes lentes
Get-Content C:\Services\EBP-MCP-Server\logs\performance.log | 
    Where-Object {$_ -match "duration: (\d+)ms" -and $Matches[1] -gt 3000}

# 3. Nettoyer le cache Node.js
Remove-Item C:\Services\EBP-MCP-Server\node_modules\.cache -Recurse -Force

# 4. Red√©marrer le service
Restart-Service "EBP-MCP-Server"
```

---

## üìä Scripts de Monitoring

### Monitor en Temps R√©el
```powershell
# Cr√©er C:\Services\EBP-MCP-Server\scripts\monitor.ps1
while ($true) {
    Clear-Host
    Write-Host "=== EBP MCP Monitor - $(Get-Date -Format 'HH:mm:ss') ===" -ForegroundColor Cyan
    
    # Status service
    $svc = Get-Service "EBP-MCP-Server" -ErrorAction SilentlyContinue
    if ($svc) {
        Write-Host "Service: $($svc.Status)" -ForegroundColor $(if($svc.Status -eq "Running"){"Green"}else{"Red"})
    }
    
    # Process info
    $proc = Get-Process node -ErrorAction SilentlyContinue | Where-Object {$_.Path -like "*EBP-MCP*"}
    if ($proc) {
        Write-Host "PID: $($proc.Id)"
        Write-Host "CPU: $([math]::Round($proc.CPU, 2))%"
        Write-Host "RAM: $([math]::Round($proc.WorkingSet64/1MB, 2)) MB"
        Write-Host "Threads: $($proc.Threads.Count)"
    }
    
    # Derni√®res erreurs
    $errorLog = "C:\Services\EBP-MCP-Server\logs\error.log"
    if (Test-Path $errorLog) {
        $lastError = Get-Content $errorLog -Tail 1
        if ($lastError) {
            Write-Host "`nDerni√®re erreur:" -ForegroundColor Yellow
            Write-Host $lastError
        }
    }
    
    # Derni√®re requ√™te
    $accessLog = "C:\Services\EBP-MCP-Server\logs\access.log"
    if (Test-Path $accessLog) {
        $lastAccess = Get-Content $accessLog -Tail 1
        if ($lastAccess) {
            Write-Host "`nDerni√®re requ√™te:" -ForegroundColor Cyan
            Write-Host $lastAccess
        }
    }
    
    Start-Sleep -Seconds 5
}
```

### Dashboard de Sant√©
```powershell
function Show-Dashboard {
    $metrics = @{}
    
    # Collecter les m√©triques
    $metrics.Service = (Get-Service "EBP-MCP-Server" -ErrorAction SilentlyContinue).Status
    $metrics.Uptime = if ($metrics.Service -eq "Running") {
        $proc = Get-Process node -ErrorAction SilentlyContinue | Where-Object {$_.Path -like "*EBP-MCP*"}
        if ($proc) { (Get-Date) - $proc.StartTime }
    }
    $metrics.LogSize = [math]::Round((Get-ChildItem "C:\Services\EBP-MCP-Server\logs" -Recurse | 
        Measure-Object -Property Length -Sum).Sum / 1MB, 2)
    $metrics.ErrorsToday = (Get-Content "C:\Services\EBP-MCP-Server\logs\error.log" | 
        Where-Object {$_ -match (Get-Date).ToString('yyyy-MM-dd')} | Measure-Object).Count
    $metrics.RequestsToday = (Get-Content "C:\Services\EBP-MCP-Server\logs\access.log" | 
        Where-Object {$_ -match (Get-Date).ToString('yyyy-MM-dd')} | Measure-Object).Count
    
    # Afficher le dashboard
    Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë       EBP MCP SERVER DASHBOARD         ‚ïë" -ForegroundColor Cyan
    Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor Cyan
    Write-Host "‚ïë Status: $($metrics.Service.ToString().PadRight(31))‚ïë" -ForegroundColor $(if($metrics.Service -eq "Running"){"Green"}else{"Red"})
    Write-Host "‚ïë Uptime: $($metrics.Uptime.ToString().PadRight(31))‚ïë"
    Write-Host "‚ïë Logs Size: $($metrics.LogSize.ToString().PadRight(28)) MB‚ïë"
    Write-Host "‚ïë Errors Today: $($metrics.ErrorsToday.ToString().PadRight(25))‚ïë" -ForegroundColor $(if($metrics.ErrorsToday -gt 10){"Yellow"}else{"White"})
    Write-Host "‚ïë Requests Today: $($metrics.RequestsToday.ToString().PadRight(23))‚ïë"
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
}

# Ex√©cuter
Show-Dashboard
```

---

## üîê Sauvegardes

### Script de Backup Automatique
```powershell
# Cr√©er C:\Services\EBP-MCP-Server\scripts\backup.ps1
$backupRoot = "C:\Services\EBP-MCP-Server\backups"
$date = Get-Date -Format "yyyy-MM-dd_HHmm"
$backupPath = "$backupRoot\backup_$date"

# Cr√©er le dossier
New-Item -ItemType Directory -Path $backupPath -Force

# Sauvegarder les fichiers critiques
Copy-Item "C:\Services\EBP-MCP-Server\.env" "$backupPath\"
Copy-Item "C:\Services\EBP-MCP-Server\package.json" "$backupPath\"
Copy-Item "$env:APPDATA\Claude\claude_desktop_config.json" "$backupPath\"

# Compresser
Compress-Archive -Path $backupPath -DestinationPath "$backupRoot\backup_$date.zip"
Remove-Item $backupPath -Recurse

# Nettoyer les vieux backups (garder 30 jours)
Get-ChildItem "$backupRoot\*.zip" | 
    Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | 
    Remove-Item

Write-Host "‚úÖ Backup cr√©√©: $backupRoot\backup_$date.zip"
```

---

## üìù Notes Importantes

1. **Toujours tester en mode console** avant de diagnostiquer un probl√®me service
2. **Sauvegarder .env** avant toute modification
3. **Logs SQL sensibles** : Ne jamais commiter ou partager
4. **Red√©marrage mensuel** recommand√© pour √©viter les fuites m√©moire
5. **Monitor CPU** : Si > 50% constant, investiguer les requ√™tes

---

*Document cr√©√© le 09/01/2025 - √Ä usage personnel uniquement*